const TelegramBot = require('node-telegram-bot-api');
const express = require('express');
require('dotenv').config();

const token = process.env.BOT_TOKEN;
const adminChatId = process.env.ADMIN_CHAT_ID;
const port = process.env.PORT || 3000;

const bot = new TelegramBot(token, { polling: false });
const app = express();

app.use(express.json());

// Ð¥Ñ€Ð°Ð½Ð¸Ð»Ð¸Ñ‰Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹ (Ð² Ð¿Ñ€Ð¾Ð´Ð°ÐºÑˆÐµÐ½Ðµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ Ð‘Ð”)
const users = new Map();

// Webhook Ð´Ð»Ñ Telegram
app.post(`/webhook/${token}`, (req, res) => {
  bot.processUpdate(req.body);
  res.sendStatus(200);
});

// API Ð´Ð»Ñ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ð¹ Ð¿Ð¾ username/Ð¸Ð¼ÐµÐ½Ð¸
app.post('/api/notify-by-username', (req, res) => {
  const { username, message } = req.body;
  
  const telegramId = users.get(username);
  if (!telegramId) {
    return res.status(404).json({ error: 'User not found or not linked' });
  }

  bot.sendMessage(telegramId, message)
    .then(() => res.json({ success: true }))
    .catch(err => res.status(500).json({ error: err.message }));
});

// API Ð´Ð»Ñ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ð¹ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŽ
app.post('/api/notify-user', (req, res) => {
  const { telegramId, message } = req.body;
  
  bot.sendMessage(telegramId, message)
    .then(() => res.json({ success: true }))
    .catch(err => res.status(500).json({ error: err.message }));
});

// API Ð´Ð»Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ ÑÐ¿Ð¸ÑÐºÐ° Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹
app.get('/api/users', (req, res) => {
  const userList = Array.from(users.entries()).map(([username, telegramId]) => ({
    username,
    telegramId,
    linked: true
  }));
  res.json(userList);
});

// API Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð¿Ñ€Ð¸Ð²ÑÐ·ÐºÐ¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
app.get('/api/user/:username', (req, res) => {
  const { username } = req.params;
  const telegramId = users.get(username);
  
  if (telegramId) {
    res.json({ username, telegramId, linked: true });
  } else {
    res.json({ username, linked: false });
  }
});

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ /start
bot.onText(/\/start/, (msg) => {
  const chatId = msg.chat.id;
  const username = msg.from.username;
  const firstName = msg.from.first_name;
  
  // ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð¿Ñ€Ð¸Ð²ÑÐ·Ñ‹Ð²Ð°ÐµÐ¼ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð¿Ð¾ username Ð¸Ð»Ð¸ Ð¸Ð¼ÐµÐ½Ð¸
  const userKey = username ? `@${username}` : firstName;
  users.set(userKey, chatId.toString());
  
  const welcomeMessage = `
ðŸ  Ð”Ð¾Ð±Ñ€Ð¾ Ð¿Ð¾Ð¶Ð°Ð»Ð¾Ð²Ð°Ñ‚ÑŒ Ð² Ð ÐµÐ½Ñ‚Ð¾Ð»Ð¾Ð³Ð¸Ñ!

âœ… Ð’Ð°Ñˆ Ð°ÐºÐºÐ°ÑƒÐ½Ñ‚ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð¿Ñ€Ð¸Ð²ÑÐ·Ð°Ð½!
${username ? `ÐÐ¸ÐºÐ½ÐµÐ¹Ð¼: @${username}` : `Ð˜Ð¼Ñ: ${firstName}`}

Ð’Ñ‹ Ð±ÑƒÐ´ÐµÑ‚Ðµ Ð¿Ð¾Ð»ÑƒÑ‡Ð°Ñ‚ÑŒ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ Ð¾:
â€¢ ÐÐ¾Ð²Ñ‹Ñ… Ð±Ñ€Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸ÑÑ…
â€¢ ÐžÑ‚Ð¼ÐµÐ½Ð°Ñ… Ð±Ñ€Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ð¹
â€¢ ÐÐ¾Ð²Ñ‹Ñ… ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸ÑÑ… Ð² Ñ‡Ð°Ñ‚Ð°Ñ…

Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ /help Ð´Ð»Ñ Ð¿Ñ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€Ð° ÐºÐ¾Ð¼Ð°Ð½Ð´.
  `;
  
  bot.sendMessage(chatId, welcomeMessage);
  console.log(`User auto-linked: ${userKey} -> ${chatId}`);
});

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ /link Ð´Ð»Ñ Ñ€ÑƒÑ‡Ð½Ð¾Ð¹ Ð¿Ñ€Ð¸Ð²ÑÐ·ÐºÐ¸
bot.onText(/\/link (.+)/, (msg, match) => {
  const chatId = msg.chat.id;
  const userKey = match[1];
  
  users.set(userKey, chatId.toString());
  
  bot.sendMessage(chatId, `âœ… ÐÐºÐºÐ°ÑƒÐ½Ñ‚ ${userKey} ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð¿Ñ€Ð¸Ð²ÑÐ·Ð°Ð½!
Ð¢ÐµÐ¿ÐµÑ€ÑŒ Ð²Ñ‹ Ð±ÑƒÐ´ÐµÑ‚Ðµ Ð¿Ð¾Ð»ÑƒÑ‡Ð°Ñ‚ÑŒ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ Ð¾:
â€¢ ÐÐ¾Ð²Ñ‹Ñ… Ð±Ñ€Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸ÑÑ…
â€¢ ÐžÑ‚Ð¼ÐµÐ½Ð°Ñ… Ð±Ñ€Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ð¹  
â€¢ ÐÐ¾Ð²Ñ‹Ñ… ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸ÑÑ… Ð² Ñ‡Ð°Ñ‚Ð°Ñ…`);

  console.log(`User manually linked: ${userKey} -> ${chatId}`);
});

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ /help
bot.onText(/\/help/, (msg) => {
  const chatId = msg.chat.id;
  const helpMessage = `
ðŸ“‹ Ð”Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹:

/start - ÐÐ°Ñ‡Ð°Ñ‚ÑŒ Ñ€Ð°Ð±Ð¾Ñ‚Ñƒ Ð¸ Ð¿Ñ€Ð¸Ð²ÑÐ·Ð°Ñ‚ÑŒ Ð°ÐºÐºÐ°ÑƒÐ½Ñ‚
/link username - Ð ÑƒÑ‡Ð½Ð°Ñ Ð¿Ñ€Ð¸Ð²ÑÐ·ÐºÐ° Ð°ÐºÐºÐ°ÑƒÐ½Ñ‚Ð°
/help - ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ ÑÑ‚Ñƒ ÑÐ¿Ñ€Ð°Ð²ÐºÑƒ
/status - ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ ÑÑ‚Ð°Ñ‚ÑƒÑ Ð¿Ñ€Ð¸Ð²ÑÐ·ÐºÐ¸
  `;
  
  bot.sendMessage(chatId, helpMessage);
});

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ /status
bot.onText(/\/status/, (msg) => {
  const chatId = msg.chat.id;
  
  // Ð˜Ñ‰ÐµÐ¼ username Ð¿Ð¾ chat ID
  let userKey = null;
  for (const [key, id] of users.entries()) {
    if (id === chatId.toString()) {
      userKey = key;
      break;
    }
  }
  
  if (userKey) {
    bot.sendMessage(chatId, `âœ… ÐÐºÐºÐ°ÑƒÐ½Ñ‚ Ð¿Ñ€Ð¸Ð²ÑÐ·Ð°Ð½: ${userKey}`);
  } else {
    bot.sendMessage(chatId, `âŒ ÐÐºÐºÐ°ÑƒÐ½Ñ‚ Ð½Ðµ Ð¿Ñ€Ð¸Ð²ÑÐ·Ð°Ð½. Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ /start Ð´Ð»Ñ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð¹ Ð¿Ñ€Ð¸Ð²ÑÐ·ÐºÐ¸`);
  }
});

// Health check
app.get('/health', (req, res) => {
  res.json({ status: 'ok', users: users.size });
});

app.listen(port, () => {
  console.log(`Bot server running on port ${port}`);
});
